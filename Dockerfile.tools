FROM ubuntu:20.04

ARG DEBIAN_FRONTEND=noninteractive
ENV CFLAGS="-fno-omit-frame-pointer -pthread -fgraphite-identity -floop-block -ldl -lpthread -g -fPIC -I/usr/include/x86_64-linux-gnu"
ENV CXXFLAGS="-fno-omit-frame-pointer -pthread -fgraphite-identity -floop-block -ldl -lpthread -g -fPIC -I/usr/include/x86_64-linux-gnu"
ENV LDFLAGS="-Wl,-Bsymbolic -fPIC -L/usr/lib/x86_64-linux-gnu -static"
ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib:/usr/local/lib/x86_64-linux-gnu/

# Install dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        jq \
        pkg-config \
        git \
        curl \
        python3 \
        python3-pip \
        python3-setuptools \
        python3-wheel \
        python3-docutils \
        build-essential \
        nasm \
        ninja-build \
        libnuma1 \
        libgl1-mesa-glx \
        cmake \
        libass-dev \
        autoconf \
        openssl \
        libssl-dev \
        doxygen \
        automake \
        libtool \
        libevent-dev \
        libjpeg-dev \
        libgif-dev \
        libpng-dev \
        libwebp-dev \
        libmemcached-dev \
        imagemagick \
        libpython3-dev \
        libavformat-dev \
        libavcodec-dev \
        libswscale-dev \
        libavutil-dev \
        libswresample-dev \
        libdevil-dev \
        libx265-dev \
        libnuma-dev \
        vim \
        nano \
        checkinstall && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

RUN pip3 install --no-cache-dir meson cython sphinx

# Install libvmaf
COPY --from=registry.gitlab.com/luigi311/encoders-docker/aomenc:latest /vmaf.deb /packages/
#COPY --from=aomenc /vmaf.deb /packages/
RUN dpkg -i /packages/vmaf.deb

# Install aomenc
COPY --from=registry.gitlab.com/luigi311/encoders-docker/aomenc:latest /aomenc.deb /packages/
#COPY --from=aomenc /aomenc.deb /packages/
RUN dpkg -i /packages/aomenc.deb

# Install svt-av1
COPY --from=registry.gitlab.com/luigi311/encoders-docker/svt-av1:latest /svt-av1.deb /packages/
#COPY --from=svt-av1 /svt-av1.deb /packages/
RUN dpkg -i /packages/svt-av1.deb

# Install rav1e
COPY --from=registry.gitlab.com/luigi311/encoders-docker/rav1e:latest /rav1e-static/usr /usr
COPY --from=registry.gitlab.com/luigi311/encoders-docker/rav1e:latest /usr/local/bin/rav1e /usr/local/bin/rav1e
#COPY --from=rav1e /rav1e-static /
#COPY --from=rav1e /usr/local/bin/rav1e /usr/local/bin/rav1e

# Install x265
COPY --from=registry.gitlab.com/luigi311/encoders-docker/x265:latest /x265.deb /packages/
#COPY --from=x265 /x265.deb /packages/
RUN dpkg -i /packages/x265.deb

# Install svt-hevc
COPY --from=registry.gitlab.com/luigi311/encoders-docker/svt-hevc:latest /svt-hevc.deb /packages/
#COPY --from=svt-hevc /svt-hevc.deb /packages/
RUN dpkg -i /packages/svt-hevc.deb

# Install x264
COPY --from=registry.gitlab.com/luigi311/encoders-docker/x264:latest /x264.deb /packages/
#COPY --from=x264 /x264.deb /packages/
RUN dpkg -i /packages/x264.deb

# Install vpxenc
COPY --from=registry.gitlab.com/luigi311/encoders-docker/vpxenc:latest /vpxenc.deb /packages/
#COPY --from=vpxenc /vpxenc.deb /packages/
RUN dpkg -i /packages/vpxenc.deb

# Install ffmpeg
COPY --from=registry.gitlab.com/luigi311/encoders-docker/ffmpeg:latest /ffmpeg.deb /packages/
#COPY --from=ffmpeg /ffmpeg.deb /packages/
RUN dpkg -i /packages/ffmpeg.deb

ARG LDFLAGS="-Wl,-Bsymbolic -fPIC -L/usr/lib/x86_64-linux-gnu"

# Build avisynth
RUN git clone https://github.com/AviSynth/AviSynthPlus.git /AviSynthPlus && mkdir -p /AviSynthPlus/avisynth-build
WORKDIR /AviSynthPlus/avisynth-build
RUN cmake -S .. -DCMAKE_BUILD_TYPE:STRING='None' -DBUILD_SHARED_LIBS='OFF' && \
    make -j"$(nproc)" && \
    checkinstall --install=yes --default -D --pkgname "avisynth" --pkgversion "1" make install && \
    cp avisynth_*.deb /avisynth.deb

ARG LDFLAGS="-Wl,-Bsymbolic -fPIC -L/usr/lib/x86_64-linux-gnu -static"

# Install vapoursynth dependencies
RUN mkdir -p /vapoursynth/dependencies && git clone https://github.com/sekrit-twc/zimg -b master --depth=1 /vapoursynth/dependencies/zimg
WORKDIR /vapoursynth/dependencies/zimg
RUN ./autogen.sh  && \
    ./configure --enable-static --disable-shared && \
    make -j"$(nproc)" && \
    make install

# Install Vapoursynth
# Pin to 54 as 55+ breaks lsmash
RUN git clone --branch R54 https://github.com/vapoursynth/vapoursynth.git /vapoursynth/build
WORKDIR /vapoursynth/build
RUN ./autogen.sh && \
    ./configure --enable-static --disable-shared && \
    make -j"$(nproc)" && \
    checkinstall --install=yes --default -D --pkgname "vapoursynth" --pkgversion "54" make install && \
    cp vapoursynth_*.deb /vapoursynth.deb

# Install lsmash
RUN git clone https://github.com/l-smash/l-smash /lsmash
WORKDIR /lsmash
RUN ./configure && \
    make -j"$(nproc)" && \
    checkinstall --install=yes --default -D --pkgname "lsmash" make install && \
    cp lsmash_*.deb /lsmash.deb

RUN git clone https://github.com/luigi311/L-SMASH-Works /lsmash-plugin && mkdir -p /lsmash-plugin/build-vapoursynth /lsmash-plugin/build-avisynth
WORKDIR /lsmash-plugin/build-vapoursynth
RUN meson "../VapourSynth" --default-library static && \
    ninja && \
    checkinstall --install=yes --default -D --pkgname "lsmash-vapoursynth" --pkgversion "1" ninja install && \
    cp lsmash-vapoursynth_*.deb /lsmash-vapoursynth.deb

WORKDIR /lsmash-plugin/build-avisynth
RUN meson "../AviSynth" --default-library static && \
    ninja && \
    checkinstall --install=yes --default -D --pkgname "lsmash-avisynth" --pkgversion "1" ninja install && \
    cp lsmash-avisynth_*.deb /lsmash-avisynth.deb

ARG LDFLAGS="-Wl,-Bsymbolic -fPIC -L/usr/lib/x86_64-linux-gnu"

# Install ffms2
RUN git clone https://github.com/FFMS/ffms2.git /ffms2 && mkdir -p /ffms2/src/config
WORKDIR /ffms2/
RUN autoreconf -fiv && \
    ./configure --enable-static --disable-shared  && \
    make -j"$(nproc)" && \
    checkinstall --install=yes --default -D --pkgname "ffms2" make install && \
    cp ffms2_*.deb /ffms2.deb
